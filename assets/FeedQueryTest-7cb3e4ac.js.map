{"version":3,"file":"FeedQueryTest-7cb3e4ac.js","sources":["../../src/pages/FeedQueryTest.tsx"],"sourcesContent":["import { paragraphSchema } from '@milkdown/preset-commonmark';\nimport { A, useParams } from '@solidjs/router';\nimport { Component, createEffect, For, Match, onMount, Show, Switch } from 'solid-js';\nimport { createStore } from 'solid-js/store';\nimport { APP_ID } from '../App';\nimport ArticlePreview from '../components/ArticlePreview/ArticlePreview';\nimport Loader from '../components/Loader/Loader';\nimport Note from '../components/Note/Note';\nimport PageCaption from '../components/PageCaption/PageCaption';\nimport Paginator from '../components/Paginator/Paginator';\nimport { Kind } from '../constants';\nimport { useAccountContext } from '../contexts/AccountContext';\nimport { fetchArticlesFeed, fetchNotesFeed } from '../handleFeeds';\nimport { getAdvancedFeeds, getFeedItems } from '../lib/search';\nimport { subsTo } from '../sockets';\nimport { PrimalArticle, PrimalNote } from '../types/primal';\nimport { SearchFeed } from './FeedsTest';\nimport styles from './FeedsTest.module.scss';\n\nexport type FeedRange = { order_by: string, since: number, until: number };\n\nconst FeedsQueryTest: Component = () => {\n  const params = useParams();\n  const account = useAccountContext();\n\n  const [feed, setFeed] = createStore<SearchFeed>({\n    id: '',\n    name: '',\n    description: '',\n    specification: '',\n    category: ''\n  });\n\n  const [items, setItems] = createStore<PrimalNote[] | PrimalArticle[]>([]);\n\n  createEffect(() => {\n    fetchAdvancedFeeds(params.query);\n  });\n\n  createEffect(() => {\n    if (feed.id.length > 0) {\n      setItems(() => []);\n      fetchFeedItems();\n    }\n  });\n\n  const fetchAdvancedFeeds = (query: string) => {\n    const subId = `advanced_feed_${APP_ID}`;\n\n    const unsub = subsTo(subId, {\n      onEvent: (_, content) => {\n        const feeds = JSON.parse(content.content || '[]') as SearchFeed[];\n\n        let item = feeds.find(f => f.id === query);\n\n        setFeed(() => ({...item}));\n      },\n      onEose: () =>{\n        unsub();\n      },\n    });\n\n    getAdvancedFeeds(subId);\n  }\n\n  const fetchFeedItems = async (until = 0, offset = 0) => {\n    const subId = `feed_items_${feed.id}_${APP_ID}`;\n\n    if (feed.category === 'notes') {\n      const notes = await fetchNotesFeed(\n        account?.publicKey,\n        feed.specification,\n        subId,\n        20,\n        until,\n        offset,\n      );\n\n      // @ts-ignore\n      setItems((its) => [ ...its, ...notes]);\n      return;\n    }\n\n    if (feed.category === 'reads') {\n      const notes = await fetchArticlesFeed(\n        account?.publicKey,\n        feed.specification,\n        subId,\n        20,\n        until,\n        offset,\n      );\n\n      // @ts-ignore\n      setItems((its) => [ ...its, ...notes]);\n      return;\n    }\n  };\n\n  const onNextPage = () => {\n    if (feed.category === 'notes') {\n      const lastItem = items[items.length - 1] as PrimalNote;\n      const lastDate = lastItem.msg.created_at;\n      const offset = (items as PrimalNote[]).filter(i => i.msg.created_at === lastDate).length;\n\n      fetchFeedItems(lastItem.msg.created_at, offset);\n    }\n\n    if (feed.category === 'reads') {\n      const lastItem = items[items.length - 1] as PrimalArticle;\n      const lastDate = lastItem.published;\n      const offset = (items as PrimalArticle[]).filter(i => i.published === lastDate).length;\n\n      fetchFeedItems(lastItem.published, offset);\n    }\n  }\n\n  return (\n    <>\n      <Show when={feed.id.length > 0} fallback={<Loader />}>\n        <PageCaption title={feed.name} />\n\n        <div class={styles.page}>\n          <div class={styles.section}>\n            <div class={styles.feedDescription}>{feed.description}</div>\n          </div>\n          <div class={`${styles.section} ${styles.borderless}`}>\n            <div class={styles.list}>\n             <For each={items}>\n              {item => (\n                <Switch>\n                  <Match when={feed.category === 'notes'}>\n                    <Note note={item} noteType=\"feed\" />\n                  </Match>\n                  <Match when={feed.category === 'reads'}>\n                    <ArticlePreview article={item} />\n                  </Match>\n                </Switch>)\n              }\n             </For>\n             <Paginator loadNextPage={onNextPage} />\n            </div>\n          </div>\n        </div>\n      </Show>\n    </>\n  );\n}\n\nexport default FeedsQueryTest;\n"],"names":["FeedsQueryTest","params","useParams","account","useAccountContext","feed","setFeed","createStore","id","name","description","specification","category","items","setItems","createEffect","fetchAdvancedFeeds","query","length","fetchFeedItems","subId","APP_ID","unsub","subsTo","onEvent","_","content","item","JSON","parse","find","f","onEose","getAdvancedFeeds","__name","until","offset","notes","fetchNotesFeed","publicKey","its","fetchArticlesFeed","onNextPage","lastItem","lastDate","msg","created_at","filter","i","published","_$createComponent","Show","when","fallback","Loader","children","PageCaption","title","_el$","_tmpl$","_el$2","firstChild","_el$3","_el$4","nextSibling","_el$5","_$insert","For","each","Switch","Match","Note","note","noteType","ArticlePreview","article","Paginator","loadNextPage","_$effect","_p$","_v$","styles","page","_v$2","section","_v$3","feedDescription","_v$4","borderless","_v$5","list","_$className","undefined"],"mappings":"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"}