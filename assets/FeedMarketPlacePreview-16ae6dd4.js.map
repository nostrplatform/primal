{"version":3,"file":"FeedMarketPlacePreview-16ae6dd4.js","sources":["../../src/components/FeedMarketplace/FeedMarketPlacePreview.tsx"],"sourcesContent":["import { batch, Component, createEffect, For, Match, on, Switch } from 'solid-js';\nimport { createStore } from 'solid-js/store';\nimport { APP_ID } from '../../App';\nimport { useAccountContext } from '../../contexts/AccountContext';\nimport { fetchNoteFeedBySpec, fetchReadsFeedBySpec } from '../../handleNotes';\nimport { emptyPaging, fetchMegaFeed, filterAndSortNotes, filterAndSortReads, PaginationInfo } from '../../megaFeeds';\nimport { DVMMetadata, NoteActions, PrimalArticle, PrimalDVM, PrimalNote, PrimalUser } from '../../types/primal';\nimport { calculatePagingOffset } from '../../utils';\nimport ArticlePreview from '../ArticlePreview/ArticlePreview';\nimport Note from '../Note/Note';\nimport Paginator from '../Paginator/Paginator';\nimport styles from './FeedMarketPlace.module.scss';\nimport FeedMarketItem from './FeedMarketPlaceItem';\n\ntype FeedPreviewStore = {\n  notes: PrimalNote[],\n  reads: PrimalArticle[],\n  paging: PaginationInfo,\n  isFetching: boolean,\n}\n\nconst FeedMarketPlacePreview: Component<{\n  dvm: PrimalDVM | undefined,\n  author: PrimalUser | undefined,\n  stats?: { likes: number, satszapped: number},\n  actions?: NoteActions,\n  metadata?: DVMMetadata,\n  commonFollows?: PrimalUser[],\n  type?: 'notes' | 'reads',\n  isInDialog?: boolean,\n}> = (props) => {\n  const account = useAccountContext();\n\n  const [store, updateStore] = createStore<FeedPreviewStore>({\n    notes: [],\n    reads: [],\n    paging: { ...emptyPaging() },\n    isFetching: false,\n  });\n\n  const getFeedPreview = async () => {\n    if (store.isFetching || !props.type) return;\n\n    updateStore('isFetching', () => true);\n\n    const spec = props.dvm?.primal_spec ?? JSON.stringify({\n      dvm_id: props.dvm?.identifier,\n      dvm_pubkey: props.dvm?.pubkey,\n      kind: props.type,\n    });\n\n    let offset = 0;\n\n    const since = store.paging.since || 0;\n\n    if (props.type === 'reads') {\n      offset = store.reads.reduce<number>((acc, m) => {\n        // @ts-ignore\n        return since === m.published ? acc + 1 : acc\n      }, 0)\n    } else if (props.type === 'notes') {\n      offset = store.notes.reduce<number>((acc, m) => {\n        // @ts-ignore\n        return since === m.msg.created_at ? acc + 1 : acc\n      }, 0)\n    }\n\n    const { notes, reads, paging } = await fetchMegaFeed(\n      account?.publicKey,\n      spec,\n      `dvm_preview_${APP_ID}`,\n      {\n        limit: 20,\n        until: store.paging.since,\n        offset,\n      }\n    );\n\n    const sortedNotes = filterAndSortNotes(notes, paging);\n    const sortedReads = filterAndSortReads(reads, paging);\n\n    batch(() => {\n      updateStore('notes', (ns) => [ ...ns, ...sortedNotes]);\n      updateStore('reads', (rs) => [ ...rs, ...sortedReads]);\n      updateStore('paging', () => ({ ...paging }));\n    });\n\n    updateStore('isFetching', () => false);\n  };\n\n  const clearPreview = () => {\n    updateStore(() => ({\n      notes: [],\n      reads: [],\n      paging: { ...emptyPaging() },\n      isFetching: false,\n    }));\n  }\n\n  createEffect(on(() => props.dvm && props.type, () => {\n    if (props.dvm && props.type) {\n      getFeedPreview();\n    } else {\n      clearPreview();\n    }\n  }))\n\n  createEffect(() => {\n  })\n\n  return (\n    <div\n      class={`${styles.feedMarketplacePreview} ${props.isInDialog ? styles.previewInDialog : ''}`}\n    >\n      <div class={styles.dvmCaption}>\n        <FeedMarketItem\n          dvm={props.dvm}\n          author={props.author}\n          stats={props.stats}\n          metadata={props.metadata}\n          actions={props.actions}\n          size=\"header\"\n          commonUsers={props.commonFollows}\n        />\n      </div>\n\n      <div class={styles.dvmList}>\n        <Switch>\n          <Match when={props.type === 'notes'}>\n            <For each={store.notes}>\n              {note => <Note\n                note={note}\n                shorten={true}\n                noteType={'feed'}\n              />}\n            </For>\n          </Match>\n          <Match when={props.type === 'reads'}>\n            <For each={store.reads}>\n              {article => <ArticlePreview\n                article={article}\n              />}\n            </For>\n          </Match>\n        </Switch>\n      </div>\n      <Paginator\n        loadNextPage={getFeedPreview}\n      />\n    </div>\n  )\n}\n\nexport default FeedMarketPlacePreview;\n"],"names":["FeedMarketPlacePreview","props","account","useAccountContext","store","updateStore","createStore","notes","reads","paging","emptyPaging","isFetching","getFeedPreview","__name","type","spec","dvm","primal_spec","JSON","stringify","dvm_id","identifier","dvm_pubkey","pubkey","kind","offset","since","reduce","acc","m","published","msg","created_at","fetchMegaFeed","publicKey","APP_ID","limit","until","sortedNotes","filterAndSortNotes","sortedReads","filterAndSortReads","batch","ns","rs","clearPreview","createEffect","on","_el$","_tmpl$","_el$2","firstChild","_el$3","nextSibling","_$insert","_$createComponent","FeedMarketItem","author","stats","metadata","actions","size","commonUsers","commonFollows","Switch","children","Match","when","For","each","note","Note","shorten","noteType","article","ArticlePreview","Paginator","loadNextPage","_$effect","_p$","_v$","styles","feedMarketplacePreview","isInDialog","previewInDialog","_v$2","dvmCaption","_v$3","dvmList","_$className","undefined"],"mappings":"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"}