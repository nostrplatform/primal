var k=Object.defineProperty;var S=(d,e)=>k(d,"name",{value:e,configurable:!0});import{h as Y,g as K,$ as q,I as J,b8 as X,D as Q,o as ee,c$ as W,n as te,j as _,c as f,H as ne,M as B,S as M,l as $,m as v,d0 as ie,s as b,A as R,b3 as G,bb as oe,i as U,F as ae,t as L}from"./index-64dc6460.js";import{f as se,s as p,i as re}from"./ParsedNote-9900e3c8.js";const de={captionContent:".pswp-caption-content",type:"auto",horizontalEdgeThreshold:20,mobileCaptionOverlapRatio:.3,mobileLayoutBreakpoint:600,verticallyCenterImage:!1},O=class O{constructor(e,t){this.options={...de,...t},this.lightbox=e,this.lightbox.on("init",()=>{this.pswp=this.lightbox.pswp,this.initCaption()})}initCaption(){const{pswp:e}=this;e.on("change",()=>{this.showCaption(this.pswp.currSlide)}),e.on("calcSlideSize",t=>this.onCalcSlideSize(t)),e.on("slideDestroy",t=>{t.slide.dynamicCaption&&(t.slide.dynamicCaption.element&&t.slide.dynamicCaption.element.remove(),delete t.slide.dynamicCaption)}),e.on("zoomPanUpdate",({slide:t})=>{if(e.opener.isOpen&&t.dynamicCaption){if(t.currZoomLevel>t.zoomLevels.initial?this.hideCaption(t):this.showCaption(t),t.dynamicCaption.element){let n=0;if(t.currZoomLevel<=t.zoomLevels.initial){const i=t.pan.y-t.bounds.center.y;Math.abs(i)>1&&(n=i)}this.setCaptionYOffset(t.dynamicCaption.element,n)}this.adjustPanArea(t,t.currZoomLevel)}}),e.on("beforeZoomTo",t=>{this.adjustPanArea(e.currSlide,t.destZoomLevel)}),e.on("tapAction",t=>{t.originalEvent.target.closest(".pswp__dynamic-caption")&&t.preventDefault()})}adjustPanArea(e,t){e.dynamicCaption&&e.dynamicCaption.adjustedPanAreaSize&&(t>e.zoomLevels.initial?(e.panAreaSize.x=e.dynamicCaption.originalPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.originalPanAreaSize.y):(e.panAreaSize.x=e.dynamicCaption.adjustedPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.adjustedPanAreaSize.y))}useMobileLayout(){const{mobileLayoutBreakpoint:e}=this.options;return typeof e=="function"?e.call(this):typeof e=="number"&&window.innerWidth<e}hideCaption(e){if(e.dynamicCaption&&!e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!0,t.classList.add("pswp__dynamic-caption--faded"),e.captionFadeTimeout&&clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.style.visibility="hidden",delete e.captionFadeTimeout},400)}}setCaptionYOffset(e,t){e.style.transform=`translateY(${t}px)`}showCaption(e){if(e.dynamicCaption&&e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!1,t.style.visibility="visible",clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.classList.remove("pswp__dynamic-caption--faded"),delete e.captionFadeTimeout},50)}}setCaptionPosition(e,t,n){const i=t<=this.options.horizontalEdgeThreshold;e.classList[i?"add":"remove"]("pswp__dynamic-caption--on-hor-edge"),e.style.left=t+"px",e.style.top=n+"px"}setCaptionWidth(e,t){t?e.style.width=t+"px":e.style.removeProperty("width")}setCaptionType(e,t){const n=e.dataset.pswpCaptionType;t!==n&&(e.classList.add("pswp__dynamic-caption--"+t),e.classList.remove("pswp__dynamic-caption--"+n),e.dataset.pswpCaptionType=t)}updateCaptionPosition(e){if(!e.dynamicCaption||!e.dynamicCaption.type||!e.dynamicCaption.element)return;if(e.dynamicCaption.type==="mobile"){this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.element.style.removeProperty("left"),e.dynamicCaption.element.style.removeProperty("top"),this.setCaptionWidth(e.dynamicCaption.element,!1);return}const t=e.zoomLevels.initial,n=Math.ceil(e.width*t),i=Math.ceil(e.height*t);this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.type==="aside"?(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x+n,e.bounds.center.y),this.setCaptionWidth(e.dynamicCaption.element,!1)):e.dynamicCaption.type==="below"&&(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x,e.bounds.center.y+i),this.setCaptionWidth(e.dynamicCaption.element,n))}onCalcSlideSize(e){const{slide:t}=e;let n,i;if(!t.dynamicCaption){t.dynamicCaption={element:void 0,type:!1,hidden:!1};const c=this.getCaptionHTML(t);if(!c)return;t.dynamicCaption.element=document.createElement("div"),t.dynamicCaption.element.className="pswp__dynamic-caption pswp__hide-on-close",t.dynamicCaption.element.innerHTML=c,this.pswp.dispatch("dynamicCaptionUpdateHTML",{captionElement:t.dynamicCaption.element,slide:t}),t.holderElement.appendChild(t.dynamicCaption.element)}if(!t.dynamicCaption.element)return;this.storeOriginalPanAreaSize(t),t.bounds.update(t.zoomLevels.initial),this.useMobileLayout()?(t.dynamicCaption.type="mobile",i=!0):this.options.type==="auto"?t.bounds.center.x>t.bounds.center.y?t.dynamicCaption.type="aside":t.dynamicCaption.type="below":t.dynamicCaption.type=this.options.type;const m=Math.ceil(t.width*t.zoomLevels.initial),w=Math.ceil(t.height*t.zoomLevels.initial);if(this.setCaptionType(t.dynamicCaption.element,t.dynamicCaption.type),t.dynamicCaption.type==="aside"){this.setCaptionWidth(t.dynamicCaption.element,!1),n=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const c=n.x,l=m+t.bounds.center.x;t.panAreaSize.x-l<=c&&(t.panAreaSize.x-=c,this.recalculateZoomLevelAndBounds(t))}else if(t.dynamicCaption.type==="below"||i){this.setCaptionWidth(t.dynamicCaption.element,i?this.pswp.viewportSize.x:m),n=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const c=n.y;if(this.options.verticallyCenterImage)t.panAreaSize.y-=c,this.recalculateZoomLevelAndBounds(t);else{const l=w+t.bounds.center.y,y=t.panAreaSize.y-l,a=t.panAreaSize.y;if(y<=c){t.panAreaSize.y-=Math.min((c-y)*2,c),this.recalculateZoomLevelAndBounds(t);const g=t.panAreaSize.x*this.options.mobileCaptionOverlapRatio/2;i&&t.bounds.center.x>g&&(t.panAreaSize.y=a,this.recalculateZoomLevelAndBounds(t))}}}this.storeAdjustedPanAreaSize(t),this.updateCaptionPosition(t)}measureCaptionSize(e,t){const n=e.getBoundingClientRect();return this.pswp.dispatch("dynamicCaptionMeasureSize",{captionEl:e,slide:t,captionSize:{x:n.width,y:n.height}}).captionSize}recalculateZoomLevelAndBounds(e){e.zoomLevels.update(e.width,e.height,e.panAreaSize),e.bounds.update(e.zoomLevels.initial)}storeAdjustedPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.adjustedPanAreaSize||(e.dynamicCaption.adjustedPanAreaSize={}),e.dynamicCaption.adjustedPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.adjustedPanAreaSize.y=e.panAreaSize.y)}storeOriginalPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.originalPanAreaSize||(e.dynamicCaption.originalPanAreaSize={}),e.dynamicCaption.originalPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.originalPanAreaSize.y=e.panAreaSize.y)}getCaptionHTML(e){if(typeof this.options.captionContent=="function")return this.options.captionContent.call(this,e);const t=e.data.element;let n="";if(t){const i=t.querySelector(this.options.captionContent);if(i)n=i.innerHTML;else{const m=t.querySelector("img");m&&(n=m.getAttribute("alt"))}}return n}};S(O,"PhotoSwipeDynamicCaption");let H=O;const le={videoAttributes:{controls:"",playsinline:"",preload:"auto"},autoplay:!0,preventDragOffset:40};function C(d){return d&&d.data&&d.data.type==="video"}S(C,"isVideoContent");const Z=class Z{constructor(e,t){this.options=t,this.initLightboxEvents(e),e.on("init",()=>{this.initPswpEvents(e.pswp)})}initLightboxEvents(e){e.on("contentLoad",this.onContentLoad.bind(this)),e.on("contentDestroy",this.onContentDestroy.bind(this)),e.on("contentActivate",this.onContentActivate.bind(this)),e.on("contentDeactivate",this.onContentDeactivate.bind(this)),e.on("contentAppend",this.onContentAppend.bind(this)),e.on("contentResize",this.onContentResize.bind(this)),e.addFilter("isKeepingPlaceholder",this.isKeepingPlaceholder.bind(this)),e.addFilter("isContentZoomable",this.isContentZoomable.bind(this)),e.addFilter("useContentPlaceholder",this.useContentPlaceholder.bind(this)),e.addFilter("domItemData",(t,n,i)=>(t.type==="video"&&i&&(i.dataset.pswpVideoSources?t.videoSources=JSON.parse(pswpVideoSources):i.dataset.pswpVideoSrc?t.videoSrc=i.dataset.pswpVideoSrc:t.videoSrc=i.href),t))}initPswpEvents(e){e.on("pointerDown",t=>{const n=e.currSlide;if(C(n)&&this.options.preventDragOffset){const i=t.originalEvent;if(i.type==="pointerdown"){const w=Math.ceil(n.height*n.currZoomLevel)+n.bounds.center.y,c=i.pageY-e.offset.y;c>w-this.options.preventDragOffset&&c<w&&t.preventDefault()}}}),e.on("appendHeavy",t=>{C(t.slide)&&!t.slide.isActive&&t.preventDefault()}),e.on("close",()=>{C(e.currSlide.content)&&((!e.options.showHideAnimationType||e.options.showHideAnimationType==="zoom")&&(e.options.showHideAnimationType="fade"),this.pauseVideo(e.currSlide.content))})}onContentDestroy({content:e}){C(e)&&e._videoPosterImg&&(e._videoPosterImg.onload=e._videoPosterImg.onerror=null,e._videoPosterImg=null)}onContentResize(e){if(C(e.content)){e.preventDefault();const t=e.width,n=e.height,i=e.content;if(i.element&&(i.element.style.width=t+"px",i.element.style.height=n+"px"),i.slide&&i.slide.placeholder){const m=i.slide.placeholder.element.style;m.transform="none",m.width=t+"px",m.height=n+"px"}}}isKeepingPlaceholder(e,t){return C(t)?!1:e}isContentZoomable(e,t){return C(t)?!1:e}onContentActivate({content:e}){C(e)&&this.options.autoplay&&this.playVideo(e)}onContentDeactivate({content:e}){C(e)&&this.pauseVideo(e)}onContentAppend(e){C(e.content)&&(e.preventDefault(),e.content.isAttached=!0,e.content.appendImage())}onContentLoad(e){const t=e.content;if(C(e.content)&&(e.preventDefault(),!t.element)){if(t.state="loading",t.type="video",t.element=document.createElement("video"),this.options.videoAttributes)for(let n in this.options.videoAttributes)t.element.setAttribute(n,this.options.videoAttributes[n]||"");t.element.setAttribute("poster",t.data.msrc),this.preloadVideoPoster(t,t.data.msrc),t.element.style.position="absolute",t.element.style.left=0,t.element.style.top=0,t.data.videoSources?t.data.videoSources.forEach(n=>{let i=document.createElement("source");i.src=n.src,i.type=n.type,t.element.appendChild(i)}):t.data.videoSrc&&(t.element.src=t.data.videoSrc)}}preloadVideoPoster(e,t){!e._videoPosterImg&&t&&(e._videoPosterImg=new Image,e._videoPosterImg.src=t,e._videoPosterImg.complete?e.onLoaded():e._videoPosterImg.onload=e._videoPosterImg.onerror=()=>{e.onLoaded()})}playVideo(e){e.element&&e.element.play()}pauseVideo(e){e.element&&e.element.pause()}useContentPlaceholder(e,t){return C(t)?!0:e}};S(Z,"VideoContentSetup");let D=Z;const F=class F{constructor(e,t){new D(e,{...le,...t})}};S(F,"PhotoSwipeVideoPlugin");let E=F;const ce=L('<div class="animated"><div>'),x=L("<div>"),pe=L("<img>"),me=L('<div><a data-pswp-width="800" data-pswp-height="600" data-pswp-type="video"><div class="pswp-caption-content"><div><div>'),ue=L('<div><video width="148" height="148">'),he=L("<div><div>"),ve=S(d=>{K();const e=q();J();const t=new se({gallery:`#galleryimage_${d.note.id}`,children:`a.image_${d.note.post.noteId}`,showHideAnimationType:"zoom",initialZoomLevel:"fit",secondaryZoomLevel:2,maxZoomLevel:3,thumbSelector:`a.image_${d.note.post.noteId}`,preloadFirstSlide:!0,pswpModule:()=>X(()=>import("./photoswipe.esm-128e73ba.js"),[])}),[n,i]=Q({images:[]});ee(()=>{const l=d.note.content.matchAll(W);let y=l.next(),a=[];for(;!y.done;)a.push(y.value[0]),y=l.next();for(let g=0;g<a.length;g++){let r=a[g],s=e?.actions.getMedia(r,"o"),u=s?.media_url||r,h=s?.mt,z=e?.thumbnails[r]||e?.actions.getMediaUrl(r,"s")||e?.actions.getMediaUrl(r,"m")||e?.actions.getMediaUrl(r,"o")||r;i("images",n.images.length,()=>({origUrl:r,url:u,image:s,imageThumb:z,type:h}))}new E(t,{}),new H(t,{type:"aside",captionContent:".pswp-caption-content"}),t.init()}),te(()=>{t.destroy()});const m=S(l=>{const y={...l,content:l.content.replace(W,"").trim()};return f(re,{note:y,ignoreMedia:!0,noLinks:"links",noPreviews:!0,isEmbeded:!1,noLightbox:!0})},"mediaFreeNote"),w=S(()=>n.images[0],"firstImage"),c=S(l=>!U()||l.noVideoThumbnail,"isMissingThumbnal");return(()=>{const l=ce(),y=l.firstChild;return _(y,f(ae,{get each(){return n.images},children:(a,g)=>f(ne,{get children(){return[f(B,{get when(){return a.type?.startsWith("video")},get children(){const r=me(),s=r.firstChild,u=s.firstChild,h=u.firstChild,z=h.firstChild;return _(r,f(M,{get when(){return n.images.length>1},get fallback(){return(()=>{const o=x();return $(()=>v(o,p.videoIcon)),o})()},get children(){const o=x();return $(()=>v(o,p.galleryIcon)),o}}),s),_(r,f(M,{get when(){return a.image?.dur},get children(){const o=x();return _(o,()=>ie(a.image?.dur||0)),$(()=>v(o,p.videoDuration)),o}}),s),_(s,f(M,{get when(){return!a.noVideoThumbnail},get fallback(){return(()=>{const o=ue(),I=o.firstChild;return $(A=>{const P=c(a)?p.missingThumb:"",T=a.origUrl;return P!==A._v$14&&v(o,A._v$14=P),T!==A._v$15&&b(I,"src",A._v$15=T),A},{_v$14:void 0,_v$15:void 0}),o})()},get children(){const o=pe();return o.addEventListener("error",()=>i("images",0,"noVideoThumbnail",!0)),$(()=>b(o,"src",a.imageThumb)),o}}),u),_(z,()=>m(d.note)),_(h,f(R,{get class(){return p.noteLink},get href(){return`/e/${d.note.noteId}`},children:"Go to note"}),null),$(o=>{const I=p.videoGallery,A=`z-index: ${n.images.length-g()}`,P=`galleryimage image_${d.note.noteId} cell_1`,T=a.image?.media_url,V=a.image?.media_url,j=p.mediaNote,N=p.note;return I!==o._v$5&&v(r,o._v$5=I),o._v$6=G(r,A,o._v$6),P!==o._v$7&&v(s,o._v$7=P),T!==o._v$8&&b(s,"href",o._v$8=T),V!==o._v$9&&b(s,"data-pswp-video-src",o._v$9=V),j!==o._v$10&&v(h,o._v$10=j),N!==o._v$11&&v(z,o._v$11=N),o},{_v$5:void 0,_v$6:void 0,_v$7:void 0,_v$8:void 0,_v$9:void 0,_v$10:void 0,_v$11:void 0}),r}}),f(B,{when:!0,get children(){const r=x();return _(r,f(M,{get when(){return n.images.length>1},get children(){const s=x();return $(()=>v(s,p.galleryIcon)),s}}),null),_(r,f(oe,{get class(){return`galleryimage image_${d.note.post.noteId} cell_1`},get src(){return a.url},get media(){return a.image},get mediaThumb(){return a.imageThumb},get altSrc(){return a.imageThumb},get isDev(){return U()},width:210,shortHeight:!0,plainBorder:!0,get caption(){return(()=>{const s=he(),u=s.firstChild;return _(u,()=>m(d.note)),_(s,f(R,{get class(){return p.noteLink},get href(){return`/e/${d.note.noteId}`},children:"Go to note"}),null),$(h=>{const z=p.mediaNote,o=p.note;return z!==h._v$16&&v(s,h._v$16=z),o!==h._v$17&&v(u,h._v$17=o),h},{_v$16:void 0,_v$17:void 0}),s})()}}),null),$(s=>{const u=p.videoGallery,h=`z-index: ${n.images.length-g()}`;return u!==s._v$12&&v(r,s._v$12=u),s._v$13=G(r,h,s._v$13),s},{_v$12:void 0,_v$13:void 0}),r}})]}})})),$(a=>{const g=`galleryimage_${d.note.id}`,r=d.note.id,s=w()?.url,u=p.imageGallery;return g!==a._v$&&b(l,"id",a._v$=g),r!==a._v$2&&b(l,"data-note",a._v$2=r),s!==a._v$3&&b(l,"data-url",a._v$3=s),u!==a._v$4&&v(y,a._v$4=u),a},{_v$:void 0,_v$2:void 0,_v$3:void 0,_v$4:void 0}),l})()},"NoteGallery"),ge=Y(ve);export{ge as N};
//# sourceMappingURL=NoteGallery-bea6c77c.js.map
