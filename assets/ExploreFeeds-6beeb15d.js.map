{"version":3,"file":"ExploreFeeds-6beeb15d.js","sources":["../../src/pages/Explore/ExploreFeeds.tsx"],"sourcesContent":["import { Component, createEffect, createSignal, onCleanup, onMount, Show } from 'solid-js';\nimport styles from './Explore.module.scss';\nimport { useToastContext } from '../../components/Toaster/Toaster';\nimport { useSettingsContext } from '../../contexts/SettingsContext';\nimport StickySidebar from '../../components/StickySidebar/StickySidebar';\nimport Wormhole from '../../components/Wormhole/Wormhole';\nimport { toast as t, explore as tExplore, actions as tAction } from '../../translations';\nimport { useIntl } from '@cookbook/solid-intl';\nimport Search from '../../components/Search/Search';\nimport PageCaption from '../../components/PageCaption/PageCaption';\nimport PageTitle from '../../components/PageTitle/PageTitle';\nimport { Tabs } from '@kobalte/core/tabs';\nimport { useExploreContext } from '../../contexts/ExploreContext';\nimport { A, useLocation, useParams } from '@solidjs/router';\nimport FeedMarketPlace from '../../components/FeedMarketplace/FeedMarketPlace';\nimport FeedMarketPlacePreview from '../../components/FeedMarketplace/FeedMarketPlacePreview';\nimport { APP_ID } from '../../App';\nimport { subsTo } from '../../sockets';\nimport { Kind } from '../../constants';\nimport { DVMMetadata, DVMStats, NostrNoteActionsContent, NostrUserContent, NoteActions, PrimalArticleFeed, PrimalDVM, PrimalUser } from '../../types/primal';\nimport { createStore } from 'solid-js/store';\nimport { convertToUser } from '../../stores/profile';\nimport { fetchDVM } from '../../lib/feed';\nimport { useAccountContext } from '../../contexts/AccountContext';\nimport ButtonFlip from '../../components/Buttons/ButtonFlip';\nimport ExploreHotTopics from '../../components/ExploreSidebar/ExploreHotTopics';\nimport ExploreSidebar from '../../components/ExploreSidebar/ExploreSidebar';\nimport NostrStats from '../../components/NostrStats/NostrStats';\n\nconst ExploreFeeds: Component = () => {\n\n  const account = useAccountContext();\n  const settings = useSettingsContext();\n  const toaster = useToastContext();\n  const intl = useIntl();\n  const explore = useExploreContext();\n  const location = useLocation();\n  const params = useParams();\n\n  const [store, setStore] = createStore<{\n    dvm?: PrimalDVM,\n    stats?: DVMStats,\n    metadata?: DVMMetadata,\n    author?: PrimalUser,\n    actions?: NoteActions,\n    users?: Record<string, PrimalUser>,\n    commonFollowsPubkeys?: string[],\n  }>({});\n\n  createEffect(() => {\n    if (explore?.previewDVM) {\n      setStore(() => ({\n        dvm: explore.previewDVM,\n        stats: explore.previewDVMStats,\n        metadata: explore.previewDVMMetadata,\n        author: explore.previewDVMAuthor,\n        actions: explore.previewDVMActions,\n        users: explore.previewDVMUsers || {},\n        commonFollowsPubkeys: explore.previewDVMFollows || [],\n      }));\n      return;\n    }\n\n    if (params.id) {\n      const [identifier, pubkey] = params.id.split('_by_');\n\n      getDVM(identifier, pubkey);\n      return;\n    }\n  });\n\n  const getDVM = (identifier: string, pubkey: string) => {\n    const subId = `explore_dvm_${APP_ID}`;\n\n    const unsub = subsTo(subId, {\n      onEvent: (_, content) => {\n\n        if (content.kind === Kind.DVM) {\n          const dvmData = JSON.parse(content.content);\n\n          const dvm: PrimalDVM = {\n            id: content.id,\n            name: dvmData.name || '',\n            about: dvmData.about || '',\n            amount: dvmData.amount || 'free',\n            primalVerifiedRequired: dvmData.primalVerifiedRequired || false,\n            pubkey: content.pubkey,\n            supportedKinds: content.tags?.reduce<string[]>((acc, t: string[]) => t[0] === 'k' ? [...acc, t[1]] : acc, []) || [],\n            identifier: (content.tags?.find(t => t[0] === 'd') || ['d', ''])[1],\n            picture: dvmData.picture,\n            image: dvmData.image,\n            primal_spec: dvmData.primal_spec,\n          };\n\n          setStore('dvm', () => ({ ...dvm }));\n          return;\n        }\n        if (content.kind === Kind.Metadata) {\n          const user = content as NostrUserContent;\n\n          const autor = convertToUser(user, user.pubkey);\n\n          if (autor) {\n            setStore('users', () => ({ [user.pubkey]: {...autor}}));\n          }\n          return;\n        }\n\n        if (content.kind === Kind.NoteStats) {\n          const st = JSON.parse(content.content);\n\n          if (!st.event_id) return;\n\n          setStore('stats', () => ({\n            likes: st.likes || 0,\n            satszapped: st.satszapped || 0,\n          }));\n        }\n\n        if (content.kind === Kind.DVMMetadata) {\n          const metadata = JSON.parse(content.content);\n\n          if (!metadata.event_id) return;\n\n          setStore('metadata', () => ({ kind: metadata.kind, isPrimal: metadata.is_primal}))\n        }\n\n        if (content.kind === Kind.NoteActions) {\n          const noteActionContent = content as NostrNoteActionsContent;\n          const noteActions = JSON.parse(noteActionContent.content) as NoteActions;\n\n          setStore('actions', () => ({ ...noteActions }));\n          return;\n        }\n\n        if (content.kind === Kind.DVMFollowsActions) {\n          const followsActions = JSON.parse(content.content);\n\n          setStore('commonFollowsPubkeys', () => [...followsActions.users])\n        }\n      },\n      onEose: () => {\n        unsub();\n        if (!store.users) return;\n\n        const autor = store.users[store.dvm?.pubkey || ''];\n        if (autor) {\n          setStore('author', () => ({ ...autor }));\n        }\n      }\n    });\n\n    fetchDVM(account?.publicKey, subId, identifier, pubkey);\n  }\n\n  const dvm = () => store.dvm;\n  const stats = () => store.stats;\n  const metadata = () => store.metadata;\n  const author = () => store.author;\n  const actions = () => store.actions;\n\n  const commonUsers = () => {\n    const users = store.users;\n    if (!users) return [];\n\n    const pks = store.commonFollowsPubkeys || [];\n\n    const c = pks.reduce<PrimalUser[]>((acc, pk) => {\n      const user = users[pk];\n\n      return user ?\n        [ ...acc, { ...user }] :\n        acc;\n    }, []);\n\n\n    return c;\n  }\n\n  const generateFeedDefinition = () => {\n    const dvm = store.dvm;\n\n    if (!dvm) return;\n\n    const spec = store.dvm?.primal_spec ?? JSON.stringify({\n        dvm_id: dvm.id,\n        dvm_pubkey: dvm.pubkey,\n        kind: store.metadata?.kind || 'notes',\n      });\n\n    const feed: PrimalArticleFeed = {\n      name: dvm.name,\n      description: dvm.about,\n      spec,\n      enabled: true,\n      feedkind: 'dvm',\n    };\n\n    return feed;\n  }\n\n  const isFeedAdded = () => {\n    const feed = generateFeedDefinition();\n\n    if (!feed) return false;\n\n    return settings?.actions.isFeedAdded(feed, addFeedDestination());\n  }\n\n  const addFeedDestination = () => {\n    if (metadata()?.kind === 'reads') return 'reads';\n\n    return 'home';\n  }\n\n  const toggleFeed = () => {\n    const feed = generateFeedDefinition();\n\n    if (!feed) return;\n\n    if (isFeedAdded()) {\n      settings?.actions.removeFeed(feed, addFeedDestination());\n      return;\n    }\n\n    settings?.actions.addFeed(feed, addFeedDestination());\n  }\n\n  return (\n    <>\n      <PageTitle title={intl.formatMessage(tExplore.pageTitle)} />\n\n      <StickySidebar>\n        <div class={styles.exploreSide}>\n          <NostrStats stats={explore?.stats}/>\n\n          <ExploreHotTopics />\n\n          <ExploreSidebar />\n        </div>\n      </StickySidebar>\n\n      <PageCaption>\n        <div class={styles.exploreHeader}>\n          <div class={styles.exploreDVMFeedHeader}>\n            <A\n              class={styles.backButton}\n              href={'/explore#feeds'}\n            >\n                <div class={styles.backIcon}></div>\n                <div>Feed Marketplace</div>\n            </A>\n            <ButtonFlip\n              when={isFeedAdded()}\n              class={styles.addToFeed}\n              onClick={toggleFeed}\n              fallback={\n                <>\n                  Add this feed to your {addFeedDestination()} feed\n                </>\n              }\n              >\n              <>Remove this feed from your {addFeedDestination()} feed</>\n            </ButtonFlip>\n          </div>\n\n        </div>\n      </PageCaption>\n\n\n      <div class={styles.explorePageTabs}>\n        <div class={styles.feedMarketplaceContent}>\n          <FeedMarketPlacePreview\n            dvm={dvm()}\n            author={author()}\n            stats={stats()}\n            actions={actions()}\n            metadata={metadata()}\n            type={metadata()?.kind}\n            commonFollows={commonUsers()}\n          />\n        </div>\n      </div>\n    </>\n  )\n}\n\nexport default ExploreFeeds;\n"],"names":["ExploreFeeds","account","useAccountContext","settings","useSettingsContext","useToastContext","intl","useIntl","explore","useExploreContext","useLocation","params","useParams","store","setStore","createStore","createEffect","previewDVM","dvm","stats","previewDVMStats","metadata","previewDVMMetadata","author","previewDVMAuthor","actions","previewDVMActions","users","previewDVMUsers","commonFollowsPubkeys","previewDVMFollows","id","identifier","pubkey","split","getDVM","subId","APP_ID","unsub","subsTo","onEvent","_","content","kind","Kind","DVM","dvmData","JSON","parse","name","about","amount","primalVerifiedRequired","supportedKinds","tags","reduce","acc","t","find","picture","image","primal_spec","Metadata","user","autor","convertToUser","NoteStats","st","event_id","likes","satszapped","DVMMetadata","isPrimal","is_primal","NoteActions","noteActions","DVMFollowsActions","followsActions","onEose","fetchDVM","publicKey","commonUsers","pk","generateFeedDefinition","spec","stringify","dvm_id","dvm_pubkey","description","enabled","feedkind","isFeedAdded","feed","addFeedDestination","toggleFeed","removeFeed","addFeed","_$createComponent","PageTitle","title","formatMessage","tExplore","pageTitle","StickySidebar","children","_el$","_tmpl$","_$insert","NostrStats","ExploreHotTopics","ExploreSidebar","_$effect","_$className","styles","exploreSide","PageCaption","_el$2","_tmpl$3","_el$3","firstChild","A","backButton","href","_el$4","backIcon","_tmpl$2","ButtonFlip","when","addToFeed","onClick","fallback","_$memo","_p$","_v$","exploreHeader","_v$2","exploreDVMFeedHeader","undefined","_el$6","_el$7","FeedMarketPlacePreview","type","commonFollows","_v$3","explorePageTabs","_v$4","feedMarketplaceContent"],"mappings":"wjCA6BMA,GAA0BA,EAAAA,IAAM,CAEpC,MAAMC,EAAUC,IACVC,EAAWC,IACDC,EAAiB,EACjC,MAAMC,EAAOC,IACPC,EAAUC,IACCC,EAAa,EAC9B,MAAMC,EAASC,IAET,CAACC,EAAOC,CAAQ,EAAIC,EAQvB,CAAE,CAAA,EAELC,EAAa,IAAM,CACjB,GAAIR,GAASS,WAAY,CACvBH,EAAS,KAAO,CACdI,IAAKV,EAAQS,WACbE,MAAOX,EAAQY,gBACfC,SAAUb,EAAQc,mBAClBC,OAAQf,EAAQgB,iBAChBC,QAASjB,EAAQkB,kBACjBC,MAAOnB,EAAQoB,iBAAmB,CAAE,EACpCC,qBAAsBrB,EAAQsB,mBAAqB,CAAA,CACpD,EAAC,EACF,MACF,CAEA,GAAInB,EAAOoB,GAAI,CACb,KAAM,CAACC,EAAYC,CAAM,EAAItB,EAAOoB,GAAGG,MAAM,MAAM,EAEnDC,EAAOH,EAAYC,CAAM,EACzB,MACF,CACF,CAAC,EAED,MAAME,EAASA,EAAAA,CAACH,EAAoBC,IAAmB,CACrD,MAAMG,EAAS,eAAcC,EAAO,GAE9BC,EAAQC,EAAOH,EAAO,CAC1BI,QAASA,CAACC,EAAGC,IAAY,CAEvB,GAAIA,EAAQC,OAASC,EAAKC,IAAK,CAC7B,MAAMC,EAAUC,KAAKC,MAAMN,EAAQA,OAAO,EAEpCxB,EAAiB,CACrBa,GAAIW,EAAQX,GACZkB,KAAMH,EAAQG,MAAQ,GACtBC,MAAOJ,EAAQI,OAAS,GACxBC,OAAQL,EAAQK,QAAU,OAC1BC,uBAAwBN,EAAQM,wBAA0B,GAC1DnB,OAAQS,EAAQT,OAChBoB,eAAgBX,EAAQY,MAAMC,OAAiB,CAACC,EAAKC,IAAgBA,EAAE,CAAC,IAAM,IAAM,CAAC,GAAGD,EAAKC,EAAE,CAAC,CAAC,EAAID,EAAK,CAAE,CAAA,GAAK,CAAE,EACnHxB,YAAaU,EAAQY,MAAMI,KAAKD,GAAKA,EAAE,CAAC,IAAM,GAAG,GAAK,CAAC,IAAK,EAAE,GAAG,CAAC,EAClEE,QAASb,EAAQa,QACjBC,MAAOd,EAAQc,MACfC,YAAaf,EAAQe,aAGvB/C,EAAS,MAAO,KAAO,CAAE,GAAGI,CAAK,EAAC,EAClC,MACF,CACA,GAAIwB,EAAQC,OAASC,EAAKkB,SAAU,CAClC,MAAMC,EAAOrB,EAEPsB,EAAQC,EAAcF,EAAMA,EAAK9B,MAAM,EAEzC+B,GACFlD,EAAS,QAAS,KAAO,CAAE,CAACiD,EAAK9B,MAAM,EAAG,CAAC,GAAG+B,CAAK,CAAE,EAAC,EAExD,MACF,CAEA,GAAItB,EAAQC,OAASC,EAAKsB,UAAW,CACnC,MAAMC,EAAKpB,KAAKC,MAAMN,EAAQA,OAAO,EAErC,GAAI,CAACyB,EAAGC,SAAU,OAElBtD,EAAS,QAAS,KAAO,CACvBuD,MAAOF,EAAGE,OAAS,EACnBC,WAAYH,EAAGG,YAAc,CAC9B,EAAC,CACJ,CAEA,GAAI5B,EAAQC,OAASC,EAAK2B,YAAa,CACrC,MAAMlD,EAAW0B,KAAKC,MAAMN,EAAQA,OAAO,EAE3C,GAAI,CAACrB,EAAS+C,SAAU,OAExBtD,EAAS,WAAY,KAAO,CAAE6B,KAAMtB,EAASsB,KAAM6B,SAAUnD,EAASoD,SAAU,EAAC,CACnF,CAEA,GAAI/B,EAAQC,OAASC,EAAK8B,YAAa,CAErC,MAAMC,EAAc5B,KAAKC,MADCN,EACuBA,OAAO,EAExD5B,EAAS,UAAW,KAAO,CAAE,GAAG6D,CAAa,EAAC,EAC9C,MACF,CAEA,GAAIjC,EAAQC,OAASC,EAAKgC,kBAAmB,CAC3C,MAAMC,EAAiB9B,KAAKC,MAAMN,EAAQA,OAAO,EAEjD5B,EAAS,uBAAwB,IAAM,CAAC,GAAG+D,EAAelD,KAAK,CAAC,CAClE,CACD,EACDmD,OAAQA,IAAM,CAEZ,GADAxC,IACI,CAACzB,EAAMc,MAAO,OAElB,MAAMqC,EAAQnD,EAAMc,MAAMd,EAAMK,KAAKe,QAAU,EAAE,EAC7C+B,GACFlD,EAAS,SAAU,KAAO,CAAE,GAAGkD,CAAO,EAAC,CAE3C,CACF,CAAC,EAEDe,EAAS9E,GAAS+E,UAAW5C,EAAOJ,EAAYC,CAAM,GAjFzCE,UAoFTjB,EAAMA,EAAAA,IAAML,EAAMK,IAAZA,OACNC,EAAQA,EAAAA,IAAMN,EAAMM,MAAZA,SACRE,EAAWA,EAAAA,IAAMR,EAAMQ,SAAZA,YACXE,EAASA,EAAAA,IAAMV,EAAMU,OAAZA,UACTE,EAAUA,EAAAA,IAAMZ,EAAMY,QAAZA,WAEVwD,EAAcA,EAAAA,IAAM,CACxB,MAAMtD,EAAQd,EAAMc,MACpB,OAAKA,GAEOd,EAAMgB,sBAAwB,IAE5B0B,OAAqB,CAACC,EAAK0B,IAAO,CAC9C,MAAMnB,EAAOpC,EAAMuD,CAAE,EAErB,OAAOnB,EACL,CAAE,GAAGP,EAAK,CAAE,GAAGO,CAAM,CAAA,EACrBP,CACH,EAAE,CAAE,CAAA,EAVc,IAFDyB,eAkBdE,EAAyBA,EAAAA,IAAM,CACnC,MAAMjE,EAAML,EAAMK,IAElB,GAAI,CAACA,EAAK,OAEV,MAAMkE,EAAOvE,EAAMK,KAAK2C,aAAed,KAAKsC,UAAU,CAClDC,OAAQpE,EAAIa,GACZwD,WAAYrE,EAAIe,OAChBU,KAAM9B,EAAMQ,UAAUsB,MAAQ,OAChC,CAAC,EAUH,MARgC,CAC9BM,KAAM/B,EAAI+B,KACVuC,YAAatE,EAAIgC,MACjBkC,KAAAA,EACAK,QAAS,GACTC,SAAU,QAhBiBP,0BAsBzBQ,EAAcA,EAAAA,IAAM,CACxB,MAAMC,EAAOT,IAEb,OAAKS,EAEEzF,GAAUsB,QAAQkE,YAAYC,EAAMC,EAAoB,CAAA,EAF7C,IAHAF,eAQdE,EAAqBA,EAAAA,IACrBxE,EAAQ,GAAIsB,OAAS,QAAgB,QAElC,OAHkBkD,sBAMrBC,EAAaA,EAAAA,IAAM,CACvB,MAAMF,EAAOT,IAEb,GAAKS,EAEL,IAAID,EAAW,EAAI,CACjBxF,GAAUsB,QAAQsE,WAAWH,EAAMC,EAAoB,CAAA,EACvD,MACF,CAEA1F,GAAUsB,QAAQuE,QAAQJ,EAAMC,EAAoB,CAAA,IAVnCC,cAanB,MAAAG,CAAAA,EAEKC,GAAS,CAAA,IAACC,OAAK,CAAA,OAAE7F,EAAK8F,cAAcC,EAASC,SAAS,CAAC,EAAAL,EAAAA,EAEvDM,GAAa,CAAA,IAAAC,UAAA,CAAA,MAAAC,EAAAC,IAAAC,OAAAA,EAAAF,EAAAR,EAETW,GAAU,CAAA,IAACzF,OAAK,CAAA,OAAEX,GAASW,KAAK,CAAA,CAAA,EAAA,IAAA,EAAAwF,EAAAF,EAAAR,EAEhCY,GAAgB,CAAA,CAAA,EAAA,IAAA,EAAAF,EAAAF,EAAAR,EAEhBa,GAAc,CAAA,CAAA,EAAA,IAAA,EAAAC,MAAAC,EAAAP,EALLQ,EAAOC,WAAW,CAAA,EAAAT,CAAA,EAAAR,EAAAA,EAS/BkB,GAAW,CAAA,IAAAX,UAAA,CAAA,MAAAY,EAAAC,EAAA,EAAAC,EAAAF,EAAAG,WAAAZ,OAAAA,EAAAW,EAAArB,EAGLuB,EAAC,CAAA,IAAA,OAAA,CAAA,OACOP,EAAOQ,UAAU,EACxBC,KAAM,iBAAgB,IAAAlB,UAAA,CAAA,MAAA,EAAA,IAAA,CAAA,MAAAmB,EAAAjB,IAAAK,OAAAA,MAAAC,EAAAW,EAERV,EAAOW,QAAQ,CAAA,EAAAD,CAAA,GAAA,EAAAE,GAAA,CAAA,CAAA,CAAA,CAAA,EAAA,IAAA,EAAAlB,EAAAW,EAAArB,EAG9B6B,GAAU,CAAA,IACTC,MAAI,CAAA,OAAEpC,EAAW,CAAE,EAAA,IAAA,OAAA,CAAA,OACZsB,EAAOe,SAAS,EACvBC,QAASnC,EAAU,IACnBoC,UAAQ,CAAA,MAAAC,CAAAA,yBAAAA,EAEmBtC,CAAkB,EAAA,OAAA,CAAA,EAAA,IAAAW,UAAA,CAAA,MAAA2B,CAAAA,8BAAAA,EAIftC,CAAkB,EAAA,OAAA,CAAA,CAAA,CAAA,EAAA,IAAA,EAAAkB,EAAAqB,GAAA,CAAA,MAAAC,EAnB1CpB,EAAOqB,cAAaC,EAClBtB,EAAOuB,qBAAoBH,OAAAA,IAAAD,EAAAC,KAAArB,EAAAI,EAAAgB,EAAAC,IAAAA,CAAA,EAAAE,IAAAH,EAAAG,MAAAvB,EAAAM,EAAAc,EAAAG,KAAAA,CAAA,EAAAH,CAAA,EAAA,CAAAC,IAAAI,OAAAF,KAAAE,MAAA,CAAA,EAAArB,CAAA,CAAA,CAAA,GAAA,IAAA,CAAA,MAAAsB,EAAArB,EAAA,EAAAsB,EAAAD,EAAAnB,WAAAZ,OAAAA,EAAAgC,EAAA1C,EA4BtC2C,GAAsB,CAAA,IACrB1H,KAAG,CAAA,OAAEA,EAAG,CAAE,EAAA,IACVK,QAAM,CAAA,OAAEA,EAAM,CAAE,EAAA,IAChBJ,OAAK,CAAA,OAAEA,EAAK,CAAE,EAAA,IACdM,SAAO,CAAA,OAAEA,EAAO,CAAE,EAAA,IAClBJ,UAAQ,CAAA,OAAEA,EAAQ,CAAE,EAAA,IACpBwH,MAAI,CAAA,OAAExH,EAAU,GAAEsB,IAAI,EAAA,IACtBmG,eAAa,CAAA,OAAE7D,EAAW,CAAE,CAAA,CAAA,CAAA,EAAA8B,EAAAqB,GAAA,CAAA,MAAAW,EATtB9B,EAAO+B,gBAAeC,EACpBhC,EAAOiC,uBAAsBH,OAAAA,IAAAX,EAAAW,MAAA/B,EAAA0B,EAAAN,EAAAW,KAAAA,CAAA,EAAAE,IAAAb,EAAAa,MAAAjC,EAAA2B,EAAAP,EAAAa,KAAAA,CAAA,EAAAb,CAAA,EAAA,CAAAW,KAAAN,OAAAQ,KAAAR,MAAA,CAAA,EAAAC,CAAA,GAAA,CAAA,CAcjD,EAhQgC1I"}